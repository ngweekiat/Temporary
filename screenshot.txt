Option Explicit

Private gBrowser As AutomateBrowser   ' keep Edge alive across calls

Sub CaptureGoogleScreenshot()
    Dim msg As Dictionary
    Dim start As Date, timeoutSeconds As Long
    Dim imgData As String
    Dim imgBytes() As Byte
    Dim outPath As String

    ' Launch Edge via AutomateBrowser
    If gBrowser Is Nothing Then
        Set gBrowser = New_AutomateBrowser
        gBrowser.launch whichBrowser:=browserType.Edge, _
                        url:="about:blank", _
                        killWithoutAsking:=True
        gBrowser.cdp.Page.enable
        gBrowser.cdp.Runtime.enable
        gBrowser.cdp.Network.enable
    End If

    ' Navigate to Google
    gBrowser.cdp.Page.navigate "https://www.google.com"

    ' Wait until page load completes
    timeoutSeconds = 10
    start = Now
    Do While DateDiff("s", start, Now) < timeoutSeconds
        gBrowser.cdp.peakMessage
        Set msg = gBrowser.cdp.popMessageFromQueue
        If Not msg Is Nothing Then
            If msg.Exists("method") Then
                If msg("method") = "Page.loadEventFired" Then Exit Do
            End If
        End If
        DoEvents
    Loop

    ' Take screenshot
    imgData = gBrowser.cdp.Page.captureScreenshot("png")

    ' Decode base64 and save
    imgBytes = DecodeBase64(imgData)
    outPath = ThisWorkbook.Path & "\google_screenshot.png"
    SaveBytesToFile imgBytes, outPath

    MsgBox "Screenshot saved: " & outPath, vbInformation

    ' Close browser
    CloseBrowser
End Sub


'--------------------------------------
' Helpers
'--------------------------------------
Private Function DecodeBase64(ByVal base64String As String) As Byte()
    Dim xmlObj As Object, node As Object
    Set xmlObj = CreateObject("MSXML2.DOMDocument")
    Set node = xmlObj.CreateElement("b64")
    node.DataType = "bin.base64"
    node.Text = base64String
    DecodeBase64 = node.NodeTypedValue
End Function

Private Sub SaveBytesToFile(ByRef bytes() As Byte, ByVal filePath As String)
    Dim stream As Object
    Set stream = CreateObject("ADODB.Stream")
    With stream
        .Type = 1 'binary
        .Open
        .Write bytes
        .SaveToFile filePath, 2 'overwrite
        .Close
    End With
End Sub

Sub CloseBrowser()
    If Not gBrowser Is Nothing Then
        gBrowser.Quit
        Set gBrowser = Nothing
    End If
End Sub
