Option Explicit

Sub CaptureGoogleScreenshot()
    Dim browser As AutomateBrowser
    Dim msg As Dictionary
    Dim start As Date, timeoutSeconds As Long
    Dim imgData As String
    Dim imgBytes() As Byte
    Dim outPath As String

    ' Launch Edge browser
    Set browser = New_AutomateBrowser
    browser.launch whichBrowser:=browserType.Edge, _
                   url:="about:blank", _
                   killWithoutAsking:=True

    ' Enable required CDP domains
    browser.cdp.Page.enable
    browser.cdp.Runtime.enable
    browser.cdp.Network.enable

    ' Navigate to Google
    browser.cdp.Page.navigate "https://www.google.com"

    ' Wait for Page.loadEventFired
    timeoutSeconds = 10
    start = Now
    Do While DateDiff("s", start, Now) < timeoutSeconds
        browser.cdp.peakMessage
        Set msg = browser.cdp.popMessageFromQueue
        If Not msg Is Nothing Then
            If msg.Exists("method") Then
                If msg("method") = "Page.loadEventFired" Then Exit Do
            End If
        End If
        DoEvents
    Loop

    ' Take screenshot (PNG)
    imgData = browser.cdp.Page.captureScreenshot("png")

    ' Decode Base64 → binary → save
    imgBytes = DecodeBase64(imgData)
    outPath = ThisWorkbook.Path & "\google_screenshot.png"
    SaveBytesToFile imgBytes, outPath

    MsgBox "Screenshot saved to: " & outPath, vbInformation

    ' Close browser
    browser.Quit
End Sub


'--------------------------------------
' Helpers
'--------------------------------------
Private Function DecodeBase64(ByVal base64String As String) As Byte()
    Dim xmlObj As Object, node As Object
    Set xmlObj = CreateObject("MSXML2.DOMDocument")
    Set node = xmlObj.CreateElement("b64")
    node.DataType = "bin.base64"
    node.Text = base64String
    DecodeBase64 = node.NodeTypedValue
End Function

Private Sub SaveBytesToFile(ByRef bytes() As Byte, ByVal filePath As String)
    Dim stream As Object
    Set stream = CreateObject("ADODB.Stream")
    With stream
        .Type = 1 'binary
        .Open
        .Write bytes
        .SaveToFile filePath, 2 'overwrite
        .Close
    End With
End Sub
