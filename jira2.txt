Option Explicit

Private gBrowser As AutomateBrowser   ' keep Edge alive across calls

Function FetchXMLBySerial(ByVal serialNumber As String) As String
    Dim url As String
    Dim evalRes As Dictionary
    Dim start As Date, timeoutSeconds As Long
    Dim msg As Dictionary
    
    ' Launch browser once if not already started
    If gBrowser Is Nothing Then
        Set gBrowser = New_AutomateBrowser
        gBrowser.launch whichBrowser:=browserType.Edge, _
                        url:="about:blank", _
                        killWithoutAsking:=True
        gBrowser.cdp.Page.enable
        gBrowser.cdp.Runtime.enable
        gBrowser.cdp.Network.enable
    End If
    
    ' Build URL for this serial
    url = "https://yourserver/path/to/" & serialNumber & ".xml"
    
    ' Navigate current tab to the new URL
    gBrowser.cdp.Page.navigate url
    
    ' Wait until load event
    timeoutSeconds = 10
    start = Now
    Do While DateDiff("s", start, Now) < timeoutSeconds
        gBrowser.cdp.peakMessage
        Set msg = gBrowser.cdp.popMessageFromQueue
        If Not msg Is Nothing Then
            If msg.Exists("method") Then
                If msg("method") = "Page.loadEventFired" Then Exit Do
            End If
        End If
        DoEvents
    Loop
    
    ' Evaluate outerHTML of the loaded page
    Set evalRes = gBrowser.cdp.Runtime.evaluate("document.documentElement.outerHTML")
    
    If Not evalRes Is Nothing Then
        FetchXMLBySerial = evalRes("result")("value")
    Else
        FetchXMLBySerial = vbNullString
    End If
End Function


Sub TestFetchXML()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim r As Long
    Dim serialNumber As String
    Dim xml As String
    
    Set ws = ThisWorkbook.Sheets(1) ' adjust if needed
    
    ' Find last row in column A
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    ' Loop from row 2 downwards
    For r = 2 To lastRow
        serialNumber = Trim(ws.Cells(r, "A").Value)
        
        If Len(serialNumber) > 0 Then
            xml = FetchXMLBySerial(serialNumber)
            ' Write result into column B
            ws.Cells(r, "B").Value = xml
            Debug.Print "Row " & r & " Serial " & serialNumber & ": length=" & Len(xml)
        End If
    Next r
    
    CloseBrowser
End Sub


Sub CloseBrowser()
    If Not gBrowser Is Nothing Then
        gBrowser.Quit
        Set gBrowser = Nothing
    End If
End Sub
