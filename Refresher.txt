Option Explicit

Dim br As AutomateBrowser

Sub RefreshUntilMalicious()
    Dim js As String
    Dim value As String
    Dim start As Double
    
    ' Launch browser once
    If br Is Nothing Then
        Set br = New_AutomateBrowser
        br.launch whichBrowser:=browserType.Edge, url:="https://your-target-page.com", killWithoutAsking:=True
        br.cdp.Page.enable
        br.cdp.Runtime.enable
    End If
    
    Do
        ' Refresh
        br.cdp.Page.reload
        
        ' Wait for load
        WaitForLoad 8
        
        ' Read the target element
        js = "var el=document.querySelector('td.field-category.nowrap');" & _
             "el ? el.textContent.trim() : '';"
        
        value = br.cdp.Runtime.evaluate(js)("result")("value")
        
        Debug.Print "Current value: [" & value & "]"
        
        ' Stop when text is "Possible Malicious"
        If LCase(Trim(value)) = "possible malicious" Then Exit Do
        
        ' Wait 5 seconds
        start = Timer
        Do While Timer - start < 5
            DoEvents
        Loop
        
    Loop

    MsgBox "Detected: Possible Malicious"
End Sub


Private Sub WaitForLoad(timeoutSeconds As Long)
    Dim t As Date: t = Now
    Dim msg As Dictionary
    
    Do While DateDiff("s", t, Now) < timeoutSeconds
        br.cdp.peakMessage
        Set msg = br.cdp.popMessageFromQueue
        
        If Not msg Is Nothing Then
            If msg.Exists("method") Then
                If msg("method") = "Page.loadEventFired" Then Exit Do
            End If
        End If
        
        DoEvents
    Loop
End Sub
