Option Explicit

Sub Edge_LogAllCDPEvents_AndDumpHTML()
    Dim b As AutomateBrowser
    Dim msg As Dictionary
    Dim html As String
    Dim pageLoaded As Boolean
    Dim start As Date
    Dim timeoutSeconds As Long
    
    Set b = New_AutomateBrowser
    
    ' Launch Edge
    b.launch whichBrowser:=browserType.Edge, _
             url:="https://en.wikipedia.org/wiki/Kitten", _
             killWithoutAsking:=True
    
    ' Enable the domains we need
    b.cdp.Page.enable
    b.cdp.DOM.enable
    b.cdp.Runtime.enable
    b.cdp.Network.enable
    
    pageLoaded = False
    timeoutSeconds = 20
    start = Now
    
    ' Wait loop until page load event or timeout
    Do While (Not pageLoaded) And (DateDiff("s", start, Now) < timeoutSeconds)
        ' Pull new messages
        b.cdp.peakMessage
        
        ' Process queue
        Do
            Set msg = b.cdp.popMessageFromQueue
            If msg Is Nothing Then Exit Do
            
            ' Check for Page.loadEventFired (page finished loading)
            If msg.Exists("method") Then
                If msg("method") = "Page.loadEventFired" Then
                    pageLoaded = True
                    Debug.Print ">>> Page finished loading"
                End If
            End If
        Loop
        
        DoEvents
    Loop
    
    If Not pageLoaded Then
        Debug.Print "Timed out waiting for page to load"
    End If
    
    ' Get HTML snapshot
    html = CStr(b.jsEval("document.documentElement.outerHTML"))
    Debug.Print "=== HTML Snapshot ==="
    Debug.Print Left(html, 1000)   ' print first 1000 chars only
    Debug.Print "HTML length = " & Len(html)
    
    b.Quit
End Sub



'-------------------------------------
Option Explicit

Sub Edge_FetchXMLFile()
    Dim b As AutomateBrowser
    Dim msg As Dictionary
    Dim start As Date
    Dim timeoutSeconds As Long
    Dim requestId As String
    Dim xmlContent As String
    Dim pageLoaded As Boolean
    
    Set b = New_AutomateBrowser
    
    ' Launch Edge (go straight to the XML file)
    b.launch whichBrowser:=browserType.Edge, _
             url:="https://yourserver.example.com/path/to/file.xml", _
             killWithoutAsking:=True
    
    ' Enable domains we need
    b.cdp.Page.enable
    b.cdp.Network.enable
    
    timeoutSeconds = 20
    start = Now
    pageLoaded = False
    
    ' Wait loop: look for Network.loadingFinished for the XML
    Do While (Not pageLoaded) And (DateDiff("s", start, Now) < timeoutSeconds)
        b.cdp.peakMessage
        
        Do
            Set msg = b.cdp.popMessageFromQueue
            If msg Is Nothing Then Exit Do
            
            If msg.Exists("method") Then
                Select Case msg("method")
                    Case "Network.requestWillBeSent"
                        ' Track the request ID for the .xml file
                        If InStr(1, LCase(msg("params")("request")("url")), ".xml") > 0 Then
                            requestId = msg("params")("requestId")
                        End If
                    
                    Case "Network.loadingFinished"
                        ' Only stop if it matches our requestId
                        If requestId <> "" Then
                            If msg("params")("requestId") = requestId Then
                                pageLoaded = True
                                Debug.Print ">>> XML file finished loading"
                            End If
                        End If
                End Select
            End If
        Loop
        
        DoEvents
    Loop
    
    If requestId = "" Then
        Debug.Print "Did not see any .xml request"
    ElseIf pageLoaded Then
        ' Fetch response body of the XML request
        Dim result As Dictionary
        Set result = b.cdp.Network.getResponseBody(requestId)
        If Not result Is Nothing Then
            xmlContent = result("body")
            Debug.Print "=== XML File Content ==="
            Debug.Print Left(xmlContent, 1000)  ' print first 1000 chars
            Debug.Print "XML length = " & Len(xmlContent)
        Else
            Debug.Print "Failed to get XML body"
        End If
    End If
    
    b.Quit
End Sub
