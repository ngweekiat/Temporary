Option Explicit

Sub Edge_LogAllCDPEvents_AndDumpHTML()
    Dim b As AutomateBrowser
    Dim msg As Dictionary
    Dim html As String
    Dim pageLoaded As Boolean
    Dim start As Date
    Dim timeoutSeconds As Long
    
    Set b = New_AutomateBrowser
    
    ' Launch Edge
    b.launch whichBrowser:=browserType.Edge, _
             url:="https://en.wikipedia.org/wiki/Kitten", _
             killWithoutAsking:=True
    
    ' Enable the domains we need
    b.cdp.Page.enable
    b.cdp.DOM.enable
    b.cdp.Runtime.enable
    b.cdp.Network.enable
    
    pageLoaded = False
    timeoutSeconds = 20
    start = Now
    
    ' Wait loop until page load event or timeout
    Do While (Not pageLoaded) And (DateDiff("s", start, Now) < timeoutSeconds)
        ' Pull new messages
        b.cdp.peakMessage
        
        ' Process queue
        Do
            Set msg = b.cdp.popMessageFromQueue
            If msg Is Nothing Then Exit Do
            
            ' Check for Page.loadEventFired (page finished loading)
            If msg.Exists("method") Then
                If msg("method") = "Page.loadEventFired" Then
                    pageLoaded = True
                    Debug.Print ">>> Page finished loading"
                End If
            End If
        Loop
        
        DoEvents
    Loop
    
    If Not pageLoaded Then
        Debug.Print "Timed out waiting for page to load"
    End If
    
    ' Get HTML snapshot
    html = CStr(b.jsEval("document.documentElement.outerHTML"))
    Debug.Print "=== HTML Snapshot ==="
    Debug.Print Left(html, 1000)   ' print first 1000 chars only
    Debug.Print "HTML length = " & Len(html)
    
    b.Quit
End Sub
