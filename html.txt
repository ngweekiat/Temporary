Sub Edge_FullHTML_Headless_NetworkIdle()
    Dim b As AutomateBrowser
    Dim html As String
    Dim evt As Dictionary

    Set b = New_AutomateBrowser

    ' Launch Edge in headless mode
    b.launch whichBrowser:=browserType.Edge, _
             additionnalInlineCommands:="--headless=new --disable-gpu", _
             killWithoutAsking:=True

    ' Enable Page domain + lifecycle events
    b.cdp.Page.enable
    b.cdp.Page.setLifecycleEventsEnabled True

    ' Navigate to target page
    b.cdp.Page.navigate "https://www.google.com/"

    ' Wait until we see a lifecycleEvent with name=networkIdle
    Do
        Set evt = b.cdp.peakMessage
        If Not evt Is Nothing Then
            If evt.Exists("method") Then
                If evt("method") = "Page.lifecycleEvent" Then
                    If evt("params")("name") = "networkIdle" Then Exit Do
                End If
            End If
        End If
        DoEvents
    Loop

    ' At this point network is idle, grab the HTML
    html = CStr(b.jsEval("document.documentElement.outerHTML"))
    Debug.Print html

    b.Quit
End Sub
