Option Explicit

Sub Edge_DumpHTML_WhenIdle()
    Dim b As AutomateBrowser
    Dim msg As Dictionary
    Dim html As String
    Dim lastEventTime As Date
    Dim idleThresholdSeconds As Double
    Dim maxWaitSeconds As Long
    Dim start As Date
    
    Set b = New_AutomateBrowser
    
    ' Launch Edge (headless optional)
    b.launch whichBrowser:=browserType.Edge, _
             url:="https://en.wikipedia.org/wiki/Kitten", _
             killWithoutAsking:=True
    
    ' Enable domains that generate load events
    b.cdp.Page.enable
    b.cdp.DOM.enable
    b.cdp.Runtime.enable
    b.cdp.Network.enable
    
    ' idle detection parameters
    idleThresholdSeconds = 2     ' consider "done" if 2s pass without events
    maxWaitSeconds = 20          ' safety timeout
    start = Now
    lastEventTime = Now
    
    Do
        ' pull in new events
        b.cdp.peakMessage
        
        ' process queue (if any)
        Set msg = b.cdp.popMessageFromQueue
        If Not msg Is Nothing Then
            lastEventTime = Now   ' reset idle timer when something arrives
            
            If msg.Exists("method") Then
                Debug.Print "Event: " & msg("method")
            End If
        End If
        
        ' stop if idle long enough
        If DateDiff("s", lastEventTime, Now) >= idleThresholdSeconds Then
            Debug.Print "No events for " & idleThresholdSeconds & "s â€” assuming page is idle"
            Exit Do
        End If
        
        ' stop if hard timeout
        If DateDiff("s", start, Now) >= maxWaitSeconds Then
            Debug.Print "Timeout: gave up after " & maxWaitSeconds & "s"
            Exit Do
        End If
        
        DoEvents
    Loop
    
    ' Dump HTML snapshot
    html = CStr(b.jsEval("document.documentElement.outerHTML"))
    Debug.Print "HTML length = " & Len(html)
    
    b.Quit
End Sub
