Option Explicit

Sub Edge_LogAllCDPEvents_AndDumpHTML()
    Dim b As AutomateBrowser
    Dim msg As Dictionary
    Dim start As Date
    Dim timeoutSeconds As Long
    Dim html As String
    
    Set b = New_AutomateBrowser
    
    ' Launch Edge (headless optional; remove the inline commands to see window)
    b.launch whichBrowser:=browserType.Edge, _
             url:="https://en.wikipedia.org/wiki/Kitten", _
             killWithoutAsking:=True
    
    ' Enable the domains we want to see events from
    b.cdp.Page.enable
    b.cdp.DOM.enable
    b.cdp.Runtime.enable
    b.cdp.Network.enable
    b.cdp.Target.setDiscoverTargets True
    
    timeoutSeconds = 20
    start = Now
    
    Do While DateDiff("s", start, Now) < timeoutSeconds
        ' Step 1: pull in any new events
        b.cdp.peakMessage
        
        ' Step 2: pop and log all queued messages
        Do
            Set msg = b.cdp.popMessageFromQueue
            If msg Is Nothing Then Exit Do
            
            ' Pretty print the event/response
            If msg.Exists("method") Then
                Debug.Print "Event: " & msg("method")
            ElseIf msg.Exists("id") Then
                Debug.Print "Response to id=" & msg("id")
            Else
                Debug.Print "Message: " & JsonConverter.ConvertToJson(msg)
            End If
        Loop
        
        DoEvents
    Loop
    
    Debug.Print "=== Done logging events ==="
    
    ' Grab HTML snapshot after logging
    html = CStr(b.jsEval("document.documentElement.outerHTML"))
    Debug.Print "=== HTML Snapshot ==="
    Debug.Print html
    Debug.Print "HTML length = " & Len(html)
    
    b.Quit
End Sub
