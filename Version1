Option Explicit

Sub Edge_DumpHTML_WaitUntilIdle()
    Dim b As AutomateBrowser
    Dim msg As Dictionary
    Dim html As String
    Dim lastEventTime As Date
    Dim idleThresholdSeconds As Long
    Dim overallTimeout As Long
    Dim start As Date
    
    Set b = New_AutomateBrowser
    
    ' Launch Edge (background headless optional)
    b.launch whichBrowser:=browserType.Edge, _
             url:="https://en.wikipedia.org/wiki/Kitten", _
             killWithoutAsking:=True
    
    ' Enable domains so events fire
    b.cdp.Page.enable
    b.cdp.DOM.enable
    b.cdp.Network.enable
    b.cdp.Runtime.enable
    
    idleThresholdSeconds = 2   ' consider idle after 2s of no events
    overallTimeout = 20        ' hard stop after 20s
    start = Now
    lastEventTime = Now
    
    Do
        Set msg = b.cdp.peakMessage
        If Not msg Is Nothing Then
            If msg.Exists("method") Then
                Debug.Print "Event: " & msg("method")
                lastEventTime = Now
            End If
        End If
        
        ' if no events for idleThresholdSeconds → stop
        If DateDiff("s", lastEventTime, Now) >= idleThresholdSeconds Then
            Debug.Print "No events for " & idleThresholdSeconds & "s → stopping"
            Exit Do
        End If
        
        ' safety timeout
        If DateDiff("s", start, Now) >= overallTimeout Then
            Debug.Print "Overall timeout → stopping"
            Exit Do
        End If
        
        DoEvents
    Loop
    
    ' Dump HTML snapshot
    html = CStr(b.jsEval("document.documentElement.outerHTML"))
    Debug.Print "HTML length = " & Len(html)
    
    b.Quit
End Sub
